server:
  port: 8080

spring:
  application:
    name: lumina-gateway

  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: dev
        group: LUMINA_GROUP

      config:
        server-addr: localhost:8848
        namespace: dev
        group: LUMINA_GROUP
        file-extension: yaml

    gateway:
      routes:
        # Base 服务路由（优先级高）
        - id: lumina-base-auth-route
          uri: lb://lumina-business-base
          predicates:
            - Path=/api/v1/base/auth/**
          filters:
            - StripPrefix=0

        - id: lumina-base-users-route
          uri: lb://lumina-business-base
          predicates:
            - Path=/api/v1/base/users/**
          filters:
            - StripPrefix=0

        - id: lumina-base-roles-route
          uri: lb://lumina-business-base
          predicates:
            - Path=/api/v1/base/roles/**
          filters:
            - StripPrefix=0

        - id: lumina-base-permissions-route
          uri: lb://lumina-business-base
          predicates:
            - Path=/api/v1/base/permissions/**
          filters:
            - StripPrefix=0

        - id: lumina-base-tenants-route
          uri: lb://lumina-business-base
          predicates:
            - Path=/api/v1/base/tenants/**
          filters:
            - StripPrefix=0

        # Agent 服务路由
        - id: lumina-agent-route
          uri: lb://lumina-agent-service
          predicates:
            - Path=/api/v1/agents/**
          filters:
            - StripPrefix=0

        # 兼容旧认证服务路由（重定向到 Base 服务）
        - id: lumina-auth-route
          uri: lb://lumina-business-base
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - RewritePath=/api/v1/auth/(?<segment>.*), /api/v1/base/auth/${segment}

        - id: lumina-business-route
          uri: lb://lumina-business-service
          predicates:
            - Path=/api/v1/business/**
          filters:
            - StripPrefix=0

      # 全局配置
      default-filters:
        # JWT 认证过滤器
        - name: JwtAuthentication
        # 重试配置
        - name: Retry
          args:
            retries: 3
            statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
            methods: GET,POST
            backoff:
              firstBackoff: 10ms
              maxBackoff: 50ms
              factor: 2
              basedOnPreviousValue: false

  # Redis 配置（用于限流）
  redis:
    host: localhost
    port: 6379
    database: 0
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0

# Lumina 配置
lumina:
  jwt:
    # JWT 密钥（生产环境必须修改为复杂的随机字符串）
    secret-key: lumina-secret-key-for-jwt-token-generation-must-be-long-enough
    # Token 过期时间（毫秒，默认 7 天 = 604800000 毫秒）
    expiration: 604800000
  # 白名单路径（不需要认证的路径）
  whitelist:
    paths:
      - /api/v1/auth/login
      - /api/v1/base/auth/login
      - /actuator/health
      - /actuator/info

# 日志配置
logging:
  level:
    org.springframework.cloud.gateway: INFO
    io.lumina: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# 管理端点配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true
