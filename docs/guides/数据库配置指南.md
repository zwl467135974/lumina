# 数据库配置示例

## MySQL 配置

### 1. 创建数据库

```sql
CREATE DATABASE IF NOT EXISTS lumina_dev
CHARACTER SET utf8mb4
COLLATE utf8mb4_general_ci;
```

### 2. 创建用户（可选）

```sql
-- 创建用户
CREATE USER 'lumina'@'%' IDENTIFIED BY 'lumina123';

-- 授权
GRANT ALL PRIVILEGES ON lumina_dev.* TO 'lumina'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 3. 应用配置

在 `application.yml` 中配置：

```yaml
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    druid:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/lumina_dev?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
      username: root
      password: your_password
      initial-size: 5
      min-idle: 5
      max-active: 20
      max-wait: 60000
      time-between-eviction-runs-millis: 60000
      min-evictable-idle-time-millis: 300000
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false
      pool-prepared-statements: true
      max-pool-prepared-statement-per-connection-size: 20
```

## Redis 配置

### 1. 安装 Redis

**Windows**:
- 下载 Redis for Windows 或使用 WSL2
- 或使用 Docker: `docker run -d -p 6379:6379 redis:7-alpine`

**Linux/Mac**:
```bash
# 使用包管理器安装
brew install redis  # Mac
apt install redis-server  # Ubuntu

# 或使用 Docker
docker run -d -p 6379:6379 --name redis redis:7-alpine
```

### 2. 启动 Redis

```bash
# 直接启动
redis-server

# 或使用配置文件
redis-server /path/to/redis.conf

# Docker
docker start redis
```

### 3. 测试连接

```bash
redis-cli ping
# 应返回: PONG
```

### 4. 应用配置

在 `application.yml` 中配置：

```yaml
spring:
  redis:
    host: localhost
    port: 6379
    password:
    database: 0
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0
```

## Nacos 配置

### 1. 下载 Nacos

```bash
# 下载 Nacos 2.x 或 3.x
wget https://github.com/alibaba/nacos/releases/download/3.1.1/nacos-server-3.1.1.zip

# 或使用 curl
curl -L https://github.com/alibaba/nacos/releases/download/3.1.1/nacos-server-3.1.1.zip -o nacos-server-3.1.1.zip
```

### 2. 解压并启动

```bash
# 解压
unzip nacos-server-3.1.1.zip
cd nacos/bin

# 单机模式启动
./startup.sh -m standalone

# Windows
startup.cmd -m standalone
```

### 3. 访问 Nacos 控制台

打开浏览器访问：http://localhost:8848/nacos

默认账号密码：nacos / nacos

### 4. 创建命名空间（可选）

在 Nacos 控制台中：
1. 进入"命名空间"页面
2. 点击"新建命名空间"
3. 输入命名空间 ID: `dev`
4. 输入命名空间名称: `开发环境`
5. 点击"确定"

### 5. 应用配置

在 `application.yml` 中配置：

```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: dev
        group: LUMINA_GROUP
      config:
        server-addr: localhost:8848
        namespace: dev
        group: LUMINA_GROUP
        file-extension: yaml
```

## Docker Compose 一键启动（推荐）

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: lumina-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: lumina_dev
      MYSQL_USER: lumina
      MYSQL_PASSWORD: lumina123
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_general_ci
      - --default-authentication-plugin=mysql_native_password

  redis:
    image: redis:7-alpine
    container_name: lumina-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

  nacos:
    image: nacos/nacos-server:v3.1.1
    container_name: lumina-nacos
    environment:
      MODE: standalone
      SPRING_DATASOURCE_PLATFORM: mysql
      MYSQL_SERVICE_HOST: mysql
      MYSQL_SERVICE_PORT: 3306
      MYSQL_SERVICE_DB_NAME: nacos_config
      MYSQL_SERVICE_USER: root
      MYSQL_SERVICE_PASSWORD: root123
      JVM_XMS: 512m
      JVM_XMX: 512m
    ports:
      - "8848:8848"
      - "9848:9848"
    depends_on:
      - mysql

volumes:
  mysql-data:
  redis-data:
```

启动所有服务：

```bash
docker-compose up -d
```

查看状态：

```bash
docker-compose ps
```

查看日志：

```bash
docker-compose logs -f
```

停止服务：

```bash
docker-compose down
```

## 环境变量配置

### Linux/Mac

```bash
# 编辑 ~/.bashrc 或 ~/.zshrc
export DASHSCOPE_API_KEY=your_dashscope_api_key
export OPENAI_API_KEY=your_openai_api_key

# 重新加载配置
source ~/.bashrc
```

### Windows

```powershell
# 设置环境变量（临时）
$env:DASHSCOPE_API_KEY="your_dashscope_api_key"
$env:OPENAI_API_KEY="your_openai_api_key"

# 或设置系统环境变量（永久）
setx DASHSCOPE_API_KEY "your_dashscope_api_key"
setx OPENAI_API_KEY "your_openai_api_key"
```

## 验证连接

### 1. 验证 MySQL

```bash
mysql -h localhost -u root -p
# 输入密码后执行
SHOW DATABASES;
```

### 2. 验证 Redis

```bash
redis-cli
> PING
# 应返回: PONG
> SET test "hello"
> GET test
# 应返回: "hello"
```

### 3. 验证 Nacos

访问 http://localhost:8848/nacos，使用 nacos/nacos 登录

## 常见问题

### 1. MySQL 连接失败

**问题**: `Communications link failure`

**解决方案**:
- 检查 MySQL 是否启动
- 检查防火墙设置
- 检查连接 URL、用户名、密码

### 2. Redis 连接失败

**问题**: `Unable to connect to Redis`

**解决方案**:
- 检查 Redis 是否启动: `redis-cli ping`
- 检查端口是否被占用
- 检查防火墙设置

### 3. Nacos 启动失败

**问题**: Nacos 启动报错

**解决方案**:
- 检查 JDK 版本（需要 JDK 8+）
- 检查端口 8848 是否被占用
- 查看 Nacos 日志: `logs/nacos.log`
