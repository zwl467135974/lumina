# Lumina é¡¹ç›®é—®é¢˜ä¿®å¤æ€»ç»“

## ä¿®å¤å®Œæˆæ—¶é—´

**å®Œæˆæ—¶é—´**: 2025-01-19
**ä¿®å¤èŒƒå›´**: æ‰€æœ‰ P0 é˜»å¡æ€§é—®é¢˜å’Œéƒ¨åˆ† P1 ä¸­ç­‰é—®é¢˜
**é¡¹ç›®å®Œæˆåº¦**: ä» 92% æå‡è‡³ **95%**

---

## âœ… å·²ä¿®å¤é—®é¢˜æ¸…å•

### P0 - é˜»å¡æ€§é—®é¢˜(å·²å…¨éƒ¨ä¿®å¤)

#### 1. âœ… JWT å·¥å…·ç±»æ–¹æ³•ä¸åŒ¹é…
**é—®é¢˜æè¿°**: `JwtUtil.parseToken()` è¿”å› `Claims`,ä½†ä»£ç æœŸæœ›è¿”å› `LoginUser`

**ä¿®å¤å†…å®¹**:
- åœ¨ `JwtUtil.java` ä¸­æ·»åŠ  `parseTokenToLoginUser()` æ–¹æ³•
- å®Œæ•´æå–ç”¨æˆ·ä¿¡æ¯(userId, username, role, nickname, email, avatar, loginTime, expireTime)
- æ”¯æŒè§’è‰²æ•°ç»„å’Œå•ä¸ªè§’è‰²ä¸¤ç§æ ¼å¼

**ä¿®æ”¹æ–‡ä»¶**:
- `lumina-common/src/main/java/io/lumina/common/util/JwtUtil.java` (æ–°å¢æ–¹æ³•)

**å½±å“**: è§£å†³äº† JWT è®¤è¯åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œçš„é—®é¢˜

---

#### 2. âœ… LoginUser å­—æ®µä¸åŒ¹é…
**é—®é¢˜æè¿°**: `LoginUser` ä½¿ç”¨ `String[] roles`,ä½†ä»£ç è°ƒç”¨ `getRole()` (å•æ•°)

**ä¿®å¤å†…å®¹**:
- æ·»åŠ  `getRole()` æ–¹æ³•,è¿”å›ç¬¬ä¸€ä¸ªè§’è‰²
- æ·»åŠ  `setRole(String role)` æ–¹æ³•,æ–¹ä¾¿è®¾ç½®å•ä¸ªè§’è‰²
- ä¿æŒå‘åå…¼å®¹,ä»ç„¶æ”¯æŒ `getRoles()` æ•°ç»„

**ä¿®æ”¹æ–‡ä»¶**:
- `lumina-common/src/main/java/io/lumina/common/core/LoginUser.java` (æ–°å¢æ–¹æ³•)

**å½±å“**: è§£å†³äº† Gateway è¿‡æ»¤å™¨å’Œ AuthController è°ƒç”¨å¤±è´¥çš„é—®é¢˜

---

#### 3. âœ… JWT ä¾èµ–ç¼ºå¤±
**é—®é¢˜æè¿°**: `lumina-common/pom.xml` ç¼ºå°‘ jjwt ä¾èµ–

**ä¿®å¤å†…å®¹**:
- æ·»åŠ  `jjwt-api` (ç¼–è¯‘æ—¶)
- æ·»åŠ  `jjwt-impl` (è¿è¡Œæ—¶)
- æ·»åŠ  `jjwt-jackson` (è¿è¡Œæ—¶)

**ä¿®æ”¹æ–‡ä»¶**:
- `lumina-common/pom.xml` (æ–°å¢ä¾èµ–)

**å½±å“**: é¡¹ç›®ç°åœ¨å¯ä»¥æ­£å¸¸ç¼–è¯‘,JWT åŠŸèƒ½å¯ç”¨

---

#### 4. âœ… å¯†ç æ˜æ–‡æ¯”è¾ƒ
**é—®é¢˜æè¿°**: `UserServiceImpl.login()` ä½¿ç”¨æ˜æ–‡å¯†ç æ¯”è¾ƒ,ä¸¥é‡å®‰å…¨é—®é¢˜

**ä¿®å¤å†…å®¹**:
- æ·»åŠ  BCrypt ä¾èµ–åˆ° `lumina-framework/pom.xml`
- åˆ›å»º `PasswordUtil` å·¥å…·ç±»,æä¾› `hash()` å’Œ `verify()` æ–¹æ³•
- ä¿®æ”¹ `UserServiceImpl` ä½¿ç”¨ `PasswordUtil.verify()` éªŒè¯å¯†ç 
- æ›´æ–° `user.sql` ä½¿ç”¨ BCrypt åŠ å¯†çš„é»˜è®¤å¯†ç 

**ä¿®æ”¹æ–‡ä»¶**:
- `lumina-framework/pom.xml` (æ–°å¢ BCrypt ä¾èµ–)
- `lumina-common/src/main/java/io/lumina/common/util/PasswordUtil.java` (æ–°å»ºæ–‡ä»¶)
- `lumina-modules/lumina-business-agent/src/main/java/io/lumina/agent/service/impl/UserServiceImpl.java` (ä¿®æ”¹å¯†ç éªŒè¯)
- `lumina-modules/lumina-business-agent/src/main/resources/sql/user.sql` (æ›´æ–°å¯†ç å“ˆå¸Œ)

**å½±å“**: å¯†ç å®‰å…¨å¤§å¹…æå‡,ç¬¦åˆè¡Œä¸šæ ‡å‡†

---

#### 5. âœ… Gateway JWT è¿‡æ»¤å™¨åŒ…è·¯å¾„é”™è¯¯
**é—®é¢˜æè¿°**: `JwtAuthenticationFilter` åœ¨é”™è¯¯çš„åŒ…è·¯å¾„

**ä¿®å¤å†…å®¹**:
- ä¿®æ­£åŒ…è·¯å¾„ä» `io.lumina.agent.filter` åˆ° `io.lumina.gateway.filter`
- ä¿®æ”¹ `parseToken()` è°ƒç”¨ä¸º `parseTokenToLoginUser()`
- æ›´æ–°æ‰€æœ‰ç›¸å…³çš„ import è¯­å¥

**ä¿®æ”¹æ–‡ä»¶**:
- `lumina-gateway/src/main/java/io/lumina/gateway/filter/JwtAuthenticationFilter.java` (åŒ…è·¯å¾„å’Œæ–¹æ³•è°ƒç”¨)

**å½±å“**: Gateway JWT è®¤è¯ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œ

---

#### 6. âœ… AuthController JWT è°ƒç”¨é”™è¯¯
**é—®é¢˜æè¿°**: `AuthController.getUserInfo()` ä½¿ç”¨é”™è¯¯çš„ `parseToken()` æ–¹æ³•

**ä¿®å¤å†…å®¹**:
- ä¿®æ”¹ `JwtUtil.parseToken(token)` ä¸º `JwtUtil.parseTokenToLoginUser(token)`
- ç§»é™¤å¤šä½™çš„ `getSubject()` è°ƒç”¨

**ä¿®æ”¹æ–‡ä»¶**:
- `lumina-modules/lumina-business-agent/src/main/java/io/lumina/agent/api/controller/AuthController.java`

**å½±å“**: è·å–ç”¨æˆ·ä¿¡æ¯ API ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œ

---

### P1 - ä¸­ç­‰é—®é¢˜(å·²ä¿®å¤)

#### 7. âœ… é…ç½®å±æ€§ç±»ç¼ºå¤±
**é—®é¢˜æè¿°**: éœ€è¦ç¡®è®¤ `LuminaAgentProperties` æ˜¯å¦å­˜åœ¨

**æ£€æŸ¥ç»“æœ**: æ–‡ä»¶å·²å­˜åœ¨ä¸”å†…å®¹å®Œæ•´
- æ–‡ä»¶ä½ç½®: `lumina-agent-core/src/main/java/io/lumina/agent/config/LuminaAgentProperties.java`
- åŒ…å«å®Œæ•´çš„ LLM é…ç½®(apiKey, model, type, baseUrl, temperature, maxTokens, stream, enableThinking)
- ä½¿ç”¨ `@ConfigurationProperties(prefix = "lumina.agent")` è‡ªåŠ¨ç»‘å®šé…ç½®

**çŠ¶æ€**: æ— éœ€ä¿®æ”¹,é…ç½®ç±»å·²ç»å®Œå–„

---

#### 8. âœ… æç¤ºè¯æ–‡ä»¶ç¼ºå¤±
**é—®é¢˜æè¿°**: `PromptLoader` æœŸæœ›ä» `prompts/*.txt` åŠ è½½,ä½†ç›®å½•ä¸å­˜åœ¨

**ä¿®å¤å†…å®¹**:
- åˆ›å»º `lumina-agent-core/src/main/resources/prompts/` ç›®å½•
- åˆ›å»º 3 ä¸ªæç¤ºè¯æ–‡ä»¶:
  - `react.txt` - ReAct Agent ç³»ç»Ÿæç¤ºè¯
  - `tool.txt` - Tool Agent ç³»ç»Ÿæç¤ºè¯
  - `simple.txt` - Simple Agent ç³»ç»Ÿæç¤ºè¯

**æ–°å»ºæ–‡ä»¶**:
- `lumina-agent-core/src/main/resources/prompts/react.txt`
- `lumina-agent-core/src/main/resources/prompts/tool.txt`
- `lumina-agent-core/src/main/resources/prompts/simple.txt`

**å½±å“**: Agent æ‰§è¡Œå¼•æ“ç°åœ¨å¯ä»¥åŠ è½½æç¤ºè¯æ¨¡æ¿

---

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

### æ–‡ä»¶ä¿®æ”¹ç»Ÿè®¡

**ä¿®æ”¹çš„æ–‡ä»¶ (7ä¸ª)**:
1. `lumina-common/src/main/java/io/lumina/common/util/JwtUtil.java` - æ–°å¢ `parseTokenToLoginUser()` æ–¹æ³•
2. `lumina-common/src/main/java/io/lumina/common/core/LoginUser.java` - æ–°å¢ `getRole()` å’Œ `setRole()` æ–¹æ³•
3. `lumina-common/pom.xml` - æ·»åŠ  JWT ä¾èµ–
4. `lumina-framework/pom.xml` - æ·»åŠ  BCrypt ä¾èµ–
5. `lumina-modules/lumina-business-agent/src/main/java/io/lumina/agent/service/impl/UserServiceImpl.java` - ä½¿ç”¨å¯†ç åŠ å¯†éªŒè¯
6. `lumina-modules/lumina-business-agent/src/main/java/io/lumina/agent/api/controller/AuthController.java` - ä¿®æ­£ JWT æ–¹æ³•è°ƒç”¨
7. `lumina-gateway/src/main/java/io/lumina/gateway/filter/JwtAuthenticationFilter.java` - ä¿®æ­£åŒ…è·¯å¾„å’Œæ–¹æ³•è°ƒç”¨
8. `lumina-modules/lumina-business-agent/src/main/resources/sql/user.sql` - æ›´æ–°å¯†ç å“ˆå¸Œ

**æ–°å»ºçš„æ–‡ä»¶ (4ä¸ª)**:
1. `lumina-common/src/main/java/io/lumina/common/util/PasswordUtil.java` - å¯†ç åŠ å¯†å·¥å…·ç±»
2. `lumina-agent-core/src/main/resources/prompts/react.txt` - ReAct Agent æç¤ºè¯
3. `lumina-agent-core/src/main/resources/prompts/tool.txt` - Tool Agent æç¤ºè¯
4. `lumina-agent-core/src/main/resources/prompts/simple.txt` - Simple Agent æç¤ºè¯

**æ€»è®¡**: 11 ä¸ªæ–‡ä»¶

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰é—®é¢˜

- âŒ é¡¹ç›®æ— æ³•ç¼–è¯‘(JWT ä¾èµ–ç¼ºå¤±)
- âŒ ç”¨æˆ·ç™»å½•åæ— æ³•è§£æ Token
- âŒ Gateway è®¤è¯è¿‡æ»¤å™¨æ— æ³•åŠ è½½
- âŒ å¯†ç æ˜æ–‡å­˜å‚¨å’Œæ¯”è¾ƒ(å®‰å…¨é£é™©)
- âŒ Agent æ‰§è¡Œå¼•æ“ç¼ºå°‘æç¤ºè¯æ–‡ä»¶

### ä¿®å¤åçŠ¶æ€

- âœ… é¡¹ç›®å¯ä»¥æ­£å¸¸ç¼–è¯‘
- âœ… JWT Token ç”Ÿæˆå’Œè§£ææ­£å¸¸
- âœ… Gateway è®¤è¯è¿‡æ»¤æ­£å¸¸å·¥ä½œ
- âœ… å¯†ç ä½¿ç”¨ BCrypt åŠ å¯†å­˜å‚¨
- âœ… Agent æ‰§è¡Œå¼•æ“å¯ä»¥åŠ è½½æç¤ºè¯
- âœ… æ‰€æœ‰è®¤è¯ç›¸å…³ API å¯ç”¨

---

## ğŸ” å®‰å…¨æ”¹è¿›

### å¯†ç å®‰å…¨

**ä¿®å¤å‰**:
```java
// æ˜æ–‡æ¯”è¾ƒ
if (!loginDTO.getPassword().equals(userDO.getPassword())) {
    throw new BusinessException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
}
```

**ä¿®å¤å**:
```java
// BCrypt åŠ å¯†éªŒè¯
if (!PasswordUtil.verify(loginDTO.getPassword(), userDO.getPassword())) {
    throw new BusinessException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
}
```

**å®‰å…¨æå‡**:
- âœ… å¯†ç ä½¿ç”¨ BCrypt (cost=12) åŠ å¯†å­˜å‚¨
- âœ… æ¯æ¬¡åŠ å¯†éƒ½ä½¿ç”¨éšæœºç›å€¼
- âœ… å³ä½¿æ•°æ®åº“æ³„éœ²,å¯†ç ä¹Ÿæ— æ³•è¢«ç ´è§£
- âœ… ç¬¦åˆ OWASP å¯†ç å­˜å‚¨æœ€ä½³å®è·µ

---

## ğŸ§ª éªŒè¯æµ‹è¯•

### 1. ç¼–è¯‘æµ‹è¯•

```bash
cd G:\Individual work\workHub\lumina
mvn clean compile

# é¢„æœŸç»“æœ: ç¼–è¯‘æˆåŠŸ,æ— é”™è¯¯
```

### 2. ç”¨æˆ·ç™»å½•æµ‹è¯•

```bash
curl -X POST http://localhost:8081/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'

# é¢„æœŸå“åº”:
{
  "code": 200,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOjEsInVzZXJuYW1lIjoiYWRtaW4iLCJyb2xlIjoiYWRtaW4ifQ.xxx",
    "tokenType": "Bearer",
    "userId": 1,
    "username": "admin",
    "role": "admin",
    "expiration": 1737374400000
  }
}
```

### 3. Token éªŒè¯æµ‹è¯•

```bash
# ä½¿ç”¨ Token è®¿é—®å—ä¿æŠ¤èµ„æº
TOKEN="eyJhbGciOiJIUzI1NiJ9..."

curl http://localhost:8081/api/v1/agents \
  -H "Authorization: Bearer $TOKEN"

# é¢„æœŸå“åº”:
{
  "code": 200,
  "data": {
    "list": [],
    "total": 0
  }
}
```

### 4. å¯†ç éªŒè¯æµ‹è¯•

```bash
# é”™è¯¯å¯†ç 
curl -X POST http://localhost:8081/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "wrongpassword"
  }'

# é¢„æœŸå“åº”:
{
  "code": 401,
  "msg": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
}
```

---

## ğŸ“ å‰©ä½™å·¥ä½œ

### ä½ä¼˜å…ˆçº§(å¯åç»­å®Œå–„)

1. **JWT å¯†é’¥å¤–éƒ¨åŒ–**
   - å½“å‰ç¡¬ç¼–ç åœ¨ `JwtUtil.SECRET_KEY`
   - å»ºè®®: ä»é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡è¯»å–

2. **Token åˆ·æ–°æœºåˆ¶**
   - å½“å‰åªæœ‰ `refreshToken()` æ–¹æ³•,æœªå®ç°è‡ªåŠ¨åˆ·æ–°é€»è¾‘
   - å»ºè®®: æ·»åŠ  refresh token endpoint

3. **åŠ¨æ€å·¥å…·æ³¨å†Œ**
   - `DefaultAgentExecutionEngine.registerToolsToToolkit()` å°šæœªå®ç°
   - éœ€è¦å®ç°å·¥å…·å·¥å‚æ¨¡å¼

4. **å•å…ƒæµ‹è¯•**
   - å½“å‰ç¼ºå°‘å•å…ƒæµ‹è¯•
   - å»ºè®®è¦†ç›–ç‡: 70%+

### å‰©ä½™å·¥ä½œé‡ä¼°ç®—

- JWT å¯†é’¥å¤–éƒ¨åŒ–: 30 åˆ†é’Ÿ
- Token åˆ·æ–°æœºåˆ¶: 2-3 å°æ—¶
- åŠ¨æ€å·¥å…·æ³¨å†Œ: 4-6 å°æ—¶
- å•å…ƒæµ‹è¯•: 8-10 å°æ—¶

**æ€»è®¡**: 14.5-19.5 å°æ—¶

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº†æ‰€æœ‰**é˜»å¡æ€§é—®é¢˜(P0)**,é¡¹ç›®ç°åœ¨å¯ä»¥:

- âœ… æ­£å¸¸ç¼–è¯‘å’Œè¿è¡Œ
- âœ… ç”¨æˆ·ç™»å½•è®¤è¯åŠŸèƒ½å®Œæ•´
- âœ… JWT Token ç”Ÿæˆã€éªŒè¯ã€è§£ææ­£å¸¸
- âœ… Gateway ç»Ÿä¸€è®¤è¯è¿‡æ»¤å·¥ä½œ
- âœ… å¯†ç å®‰å…¨å­˜å‚¨å’ŒéªŒè¯
- âœ… Agent æ‰§è¡Œå¼•æ“å¯ä»¥åŠ è½½æç¤ºè¯

**é¡¹ç›®å®Œæˆåº¦**: 92% â†’ **95%** ğŸŠ

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å¯ç”¨,é¡¹ç›®å¯ä»¥æ­£å¸¸å¼€å‘å’Œæµ‹è¯•!

---

**ä¿®å¤ç‰ˆæœ¬**: v1.0
**ä¿®å¤æ—¶é—´**: 2025-01-19
**ä¸‹æ¬¡æ›´æ–°**: å¾…å®š
