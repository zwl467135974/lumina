# 工具开发指南

## 一、工具概述

工具（Tool）是 Agent 可以调用的能力，用于扩展 Agent 的功能。

---

## 二、工具类型

### 2.1 同步工具

返回 `String`，立即返回结果。

```java
@Component
public class OrderTools {
    
    @Tool(description = "查询订单信息")
    public String queryOrder(
            @ToolParam(name = "orderId", description = "订单ID") 
            String orderId) {
        
        // 同步执行
        Order order = orderService.getOrderById(Long.parseLong(orderId));
        return order != null ? order.toString() : "订单不存在";
    }
}
```

### 2.2 异步工具

返回 `Mono<String>`，支持异步操作。

```java
@Component
public class ApiTools {
    
    @Autowired
    private WebClient webClient;
    
    @Tool(description = "调用外部API")
    public Mono<String> callApi(
            @ToolParam(name = "url", description = "API地址") 
            String url) {
        
        return webClient.get()
            .uri(url)
            .retrieve()
            .bodyToMono(String.class)
            .timeout(Duration.ofSeconds(10))
            .onErrorResume(e -> Mono.just("调用失败: " + e.getMessage()));
    }
}
```

---

## 三、工具开发步骤

### 步骤1: 创建工具类

```java
@Component
public class CustomTools {
    // 工具方法
}
```

### 步骤2: 添加 @Tool 注解

```java
@Tool(description = "工具描述")
public String toolMethod(@ToolParam(name = "param") String param) {
    // 实现
}
```

### 步骤3: 注册工具

工具会自动注册（通过 Spring `@Component`），或在配置中指定：

```yaml
tools:
  - tool_method  # 对应 CustomTools.toolMethod
```

---

## 四、工具注解规范

### 4.1 @Tool

```java
@Tool(
    description = "工具描述，说明工具的功能和使用场景",
    name = "custom_tool_name"  // 可选，默认使用方法名
)
```

### 4.2 @ToolParam

```java
@ToolParam(
    name = "paramName",           // 参数名称
    description = "参数描述"       // 参数说明
)
```

**注意**: 必须使用 `name = "xxx"` 格式，不能省略 `name =`

---

## 五、工具最佳实践

### 5.1 参数验证

```java
@Tool(description = "查询订单")
public String queryOrder(
        @ToolParam(name = "orderId", description = "订单ID") 
        String orderId) {
    
    // 参数验证
    if (orderId == null || orderId.isEmpty()) {
        return "错误：订单ID不能为空";
    }
    
    try {
        Long id = Long.parseLong(orderId);
        // 查询逻辑
    } catch (NumberFormatException e) {
        return "错误：订单ID格式不正确";
    }
}
```

### 5.2 错误处理

```java
@Tool(description = "更新订单状态")
public String updateOrderStatus(
        @ToolParam(name = "orderId", description = "订单ID") 
        String orderId,
        @ToolParam(name = "status", description = "新状态") 
        String status) {
    
    try {
        orderService.updateStatus(Long.parseLong(orderId), status);
        return "订单状态已更新";
    } catch (Exception e) {
        log.error("更新订单状态失败", e);
        return "错误：" + e.getMessage();
    }
}
```

### 5.3 返回格式

返回清晰、结构化的结果：

```java
@Tool(description = "查询订单")
public String queryOrder(@ToolParam(name = "orderId") String orderId) {
    Order order = orderService.getOrderById(Long.parseLong(orderId));
    
    if (order == null) {
        return "订单不存在";
    }
    
    // 返回结构化信息
    return String.format(
        "订单信息：\n" +
        "- 订单号：%s\n" +
        "- 状态：%s\n" +
        "- 金额：%.2f元\n" +
        "- 创建时间：%s",
        order.getOrderNo(),
        order.getStatus(),
        order.getAmount(),
        order.getCreateTime()
    );
}
```

---

## 六、工具分类

### 6.1 业务工具

**位置**: `lumina-agent-{domain}` 模块

**职责**: 特定业务的工具

**示例**:
- `OrderTools` - 订单相关工具
- `PaymentTools` - 支付相关工具

### 6.2 通用工具

**位置**: `lumina-agent-core` 模块

**职责**: 通用工具（文件操作、API 调用等）

**示例**:
- `FileTools` - 文件操作
- `HttpTools` - HTTP 请求
- `DateTools` - 日期处理

---

## 七、工具依赖

### 7.1 依赖业务服务

```java
@Component
public class OrderTools {
    
    @Autowired
    private OrderService orderService;  // 依赖业务服务
    
    @Tool(description = "查询订单")
    public String queryOrder(@ToolParam(name = "orderId") String orderId) {
        return orderService.getOrderById(Long.parseLong(orderId)).toString();
    }
}
```

### 7.2 依赖外部服务

```java
@Component
public class ApiTools {
    
    @Autowired
    private WebClient webClient;  // 依赖外部服务
    
    @Tool(description = "调用API")
    public Mono<String> callApi(@ToolParam(name = "url") String url) {
        return webClient.get().uri(url).retrieve().bodyToMono(String.class);
    }
}
```

---

## 八、工具测试

### 8.1 单元测试

```java
@Test
void testQueryOrder() {
    OrderTools tools = new OrderTools();
    tools.setOrderService(mockOrderService);
    
    String result = tools.queryOrder("123");
    assertEquals("订单信息：...", result);
}
```

### 8.2 集成测试

```java
@Test
void testToolInAgent() {
    // 创建 Agent，注册工具
    Agent agent = ReActAgent.builder()
        .toolkit(new Toolkit().registerTool(new OrderTools()))
        .build();
    
    // 测试 Agent 调用工具
    // ...
}
```

---

## 九、工具命名规范

### 9.1 工具类命名

- 使用 `{Domain}Tools` 格式
- 示例: `OrderTools`, `PaymentTools`, `CustomerTools`

### 9.2 工具方法命名

- 使用动词开头
- 示例: `queryOrder`, `updateStatus`, `sendNotification`

---

## 十、常见问题

### 10.1 工具未注册

**问题**: Agent 无法调用工具

**解决**: 
- 检查工具类是否有 `@Component` 注解
- 检查工具是否在配置中指定
- 检查工具名称是否正确

### 10.2 参数格式错误

**问题**: 工具调用失败，参数格式不正确

**解决**:
- 检查 `@ToolParam` 注解格式
- 确保参数类型正确
- 添加参数验证

---

**文档版本**: v1.0  
**创建时间**: 2025-01-XX

