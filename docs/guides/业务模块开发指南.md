# 业务模块开发指南

## 一、模块类型

### 1.1 传统业务模块

**命名**: `lumina-business-{domain}`

**职责**: 实现传统业务逻辑（Java 代码）

**结构**: 标准分层架构（API、Service、Domain、Infrastructure）

### 1.2 Agent 业务模块

**命名**: `lumina-agent-{domain}`

**职责**: 封装 Agent 能力，提供业务接口

**结构**: 业务配置 + Agent 服务封装

---

## 二、传统业务模块开发

### 2.1 创建模块

```bash
lumina-modules/
└── lumina-business-order/
    └── src/main/java/io/lumina/business/order/
        ├── api/
        ├── service/
        ├── domain/
        └── infrastructure/
```

### 2.2 开发步骤

1. **设计领域模型**（Domain 层）
2. **实现业务逻辑**（Service 层）
3. **设计接口**（API 层）
4. **实现持久化**（Infrastructure 层）

**参考**: [Lumina开发规范与编码标准.md](./Lumina开发规范与编码标准.md)

---

## 三、Agent 业务模块开发

### 3.1 创建模块

```bash
lumina-modules/
└── lumina-agent-customer/
    ├── src/main/java/io/lumina/agent/customer/
    │   ├── service/
    │   │   └── CustomerAgentService.java
    │   └── api/
    │       └── CustomerAgentController.java
    └── src/main/resources/
        ├── agent-config/
        │   └── customer-service.yaml
        ├── prompt/
        │   └── customer-service.md
        └── tools/
            └── customer-tools.json
```

### 3.2 开发步骤

#### 步骤1: 创建业务配置

```yaml
# src/main/resources/agent-config/customer-service.yaml
agent:
  name: customer_service_agent
  model:
    type: dashscope
    modelName: qwen-plus
  prompt: classpath:prompt/customer-service.md
  tools:
    - query_order
    - update_order_status
  memory:
    type: in_memory
    maxSize: 100
```

#### 步骤2: 编写提示词

```markdown
# src/main/resources/prompt/customer-service.md
你是一个专业的客服助手，负责处理客户咨询。

## 可用工具
- query_order: 查询订单信息
- update_order_status: 更新订单状态

## 注意事项
- 保持友好和专业的态度
- 准确理解客户需求
- 及时响应客户问题
```

#### 步骤3: 实现 Agent 服务

```java
@Service
public class CustomerAgentService {
    
    @Autowired
    private AgentExecutionEngine agentEngine;
    
    public Mono<CustomerServiceResult> handleInquiry(
            CustomerInquiryRequest request) {
        
        // 构建任务
        String task = String.format(
            "客户咨询：%s\n客户ID：%s", 
            request.getQuestion(), 
            request.getCustomerId()
        );
        
        // 调用 Agent 引擎
        return agentEngine.execute(
                "customer_service",  // 业务类型
                task,
                null  // 使用默认配置
        ).map(result -> {
            // 转换结果
            CustomerServiceResult serviceResult = new CustomerServiceResult();
            serviceResult.setAnswer(result.getResult());
            serviceResult.setToolCalls(result.getToolCalls());
            return serviceResult;
        });
    }
}
```

#### 步骤4: 创建业务接口（可选）

```java
@RestController
@RequestMapping("/api/v1/agent/customer")
public class CustomerAgentController {
    
    @Autowired
    private CustomerAgentService customerAgentService;
    
    @PostMapping("/inquiry")
    public R<CustomerServiceResult> handleInquiry(
            @RequestBody CustomerInquiryRequest request) {
        
        return customerAgentService.handleInquiry(request)
            .map(R::success)
            .block();
    }
}
```

---

## 四、工具开发

### 4.1 创建工具类

```java
@Component
public class OrderTools {
    
    @Autowired
    private OrderService orderService;
    
    @Tool(description = "查询订单信息")
    public String queryOrder(
            @ToolParam(name = "orderId", description = "订单ID") 
            String orderId) {
        
        Order order = orderService.getOrderById(Long.parseLong(orderId));
        if (order == null) {
            return "订单不存在";
        }
        
        return String.format(
            "订单信息：订单号=%s, 状态=%s, 金额=%.2f",
            order.getOrderNo(),
            order.getStatus(),
            order.getAmount()
        );
    }
    
    @Tool(description = "更新订单状态")
    public String updateOrderStatus(
            @ToolParam(name = "orderId", description = "订单ID") 
            String orderId,
            @ToolParam(name = "status", description = "新状态") 
            String status) {
        
        orderService.updateStatus(Long.parseLong(orderId), status);
        return "订单状态已更新";
    }
}
```

### 4.2 注册工具

工具会自动注册（通过 Spring `@Component`），或在配置中指定：

```yaml
tools:
  - query_order    # 对应 OrderTools.queryOrder
  - update_order_status  # 对应 OrderTools.updateOrderStatus
```

---

## 五、依赖配置

### 5.1 Maven 依赖

```xml
<dependencies>
    <!-- 核心模块 -->
    <dependency>
        <groupId>io.lumina</groupId>
        <artifactId>lumina-common</artifactId>
    </dependency>
    
    <!-- Agent 核心（Agent 业务模块需要） -->
    <dependency>
        <groupId>io.lumina</groupId>
        <artifactId>lumina-agent-core</artifactId>
    </dependency>
    
    <!-- 传统业务模块（Agent 业务模块可选依赖） -->
    <dependency>
        <groupId>io.lumina</groupId>
        <artifactId>lumina-business-order</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>
```

---

## 六、最佳实践

### 6.1 业务配置

- 提示词放在 `resources/prompt/` 目录
- 配置文件放在 `resources/agent-config/` 目录
- 使用 YAML 格式，便于维护

### 6.2 错误处理

```java
return agentEngine.execute(businessType, task, config)
    .onErrorResume(e -> {
        log.error("Agent 执行失败", e);
        return Mono.just(createErrorResult(e));
    });
```

### 6.3 性能优化

- 使用流式输出（`stream()`）处理长文本
- 设置合理的超时时间
- 缓存 Agent 实例（如果支持）

---

## 七、示例项目

参考示例：
- `lumina-agent-customer` - 客服 Agent
- `lumina-agent-analysis` - 数据分析 Agent

---

**文档版本**: v1.0  
**创建时间**: 2025-01-XX

